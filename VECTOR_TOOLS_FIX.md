# Vector Tools Fix - Single Quote Issue

## Problem Identified

The `vector_nearest_neighbor` and `vector_ask_documents` tools were failing because they used **double quotes** for string literals in AllegroGraph magic predicates, but AllegroGraph requires **single quotes**.

## Root Cause

### Working Query (manually constructed by Claude)
```sparql
PREFIX llm: <http://franz.com/ns/allegrograph/8.0.0/llm/>
PREFIX : <http://franz.com/ns/keyword#>

SELECT ?term ?score ?id
WHERE {
  (?id ?score ?term) llm:nearestNeighbor (
    'fight against poverty'      # ← SINGLE QUOTES ✓
    'demos:chomsky47'             # ← SINGLE QUOTES ✓
    :minScore 0.0
    :topN 10
  )
}
```

### Broken Query (generated by tools before fix)
```sparql
SELECT ?id ?score ?text WHERE {
  (?id ?score ?text) llm:nearestNeighbor (
    "fight against poverty"       # ← DOUBLE QUOTES ✗
    "demos:chomsky47"             # ← DOUBLE QUOTES ✗
    kw:topN 10
    kw:minScore 0.0
  ) .
}
```

## Changes Made

### File: `src/index.ts`

#### 1. Fixed `handleVectorNearestNeighbor` (line ~1478)

**Before:**
```typescript
llm:nearestNeighbor ("${text.replace(/"/g, '\\"')}" "${vectorStoreSpec}" kw:topN ${topN}...
```

**After:**
```typescript
llm:nearestNeighbor ('${text.replace(/'/g, "\\'")}' '${vectorStoreSpec}' kw:topN ${topN}...
```

#### 2. Fixed `handleVectorAskDocuments` (line ~1567)

**Before:**
```typescript
llm:askMyDocuments ("${question.replace(/"/g, '\\"')}" "${vectorStoreSpec}" kw:topN ${topN}...
```

**After:**
```typescript
llm:askMyDocuments ('${question.replace(/'/g, "\\'")}' '${vectorStoreSpec}' kw:topN ${topN}...
```

## Key Changes

1. **Replaced double quotes with single quotes** for string literals
2. **Updated escape logic** from escaping `"` to escaping `'`
3. Both `text`/`question` and `vectorStoreSpec` now use single quotes

## Verification

Created comprehensive test suites:
- `src/vector-tools.test.ts` - Tests vector store name construction (catalog prepending)
- `src/verify-fix.test.ts` - Tests that queries use single quotes correctly

All 19 tests pass ✓

## Impact

After this fix, both tools should now work correctly when called:

```javascript
// vector_nearest_neighbor
{
  text: "fight against poverty",
  vectorStore: "chomsky47",  // Will become 'demos:chomsky47' with single quotes
  topN: 10,
  minScore: 0.0
}

// vector_ask_documents
{
  question: "What causes poverty?",
  vectorStore: "chomsky47",  // Will become 'demos:chomsky47' with single quotes
  topN: 5,
  minScore: 0.8
}
```

## Testing with AllegroGraph

To test the fix:
1. Rebuild: `npm run build`
2. Restart the MCP server
3. Call `vector_ask_documents` with the same parameters that previously failed
4. The generated SPARQL query will now match the working format

## Related Code

The vector store name construction logic (prepending catalog) was already correct:

```typescript
const vectorStoreSpec = vectorStore.includes(':')
  ? vectorStore
  : `${config.catalog}:${vectorStore}`;
```

This properly converts `"chomsky47"` → `"demos:chomsky47"` when the catalog is `"demos"`.
